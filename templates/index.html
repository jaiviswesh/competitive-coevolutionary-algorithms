<!DOCTYPE html>
<html>
<head>
    <title>HUNTED Simulation</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: #eee; text-align: center; }
        #canvas-container { margin: 20px auto; display: inline-block; border: 4px solid #444; }
        canvas { background: #1a1a1a; display: block; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .legend { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

    <h1>HUNTED Swarm Prototype</h1>
    <button onclick="resetGame()">Start / Reset Simulation</button>
    
    <div id="canvas-container">
        <canvas id="simCanvas" width="800" height="800"></canvas>
    </div>

    <div class="legend">
        <span style="color:#00aaff">● Drones (start at center)</span> | 
        <span style="color:#ff4444">● Prey (free)</span> | 
        <span style="color:#ff9900">● Detected</span> | 
        <span style="color:#00ff00">■ Reached</span> | 
        <span style="color:#000000">✖ Caught</span>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        let gameInterval = null;

        // Base coordinates (Hardcoded to match sim logic for visualization)
        const W = 800, H = 800;
        // Single central base (simulation now uses one base at the center)
        const bases = [ {x: W/2, y: H/2} ];

        async function resetGame() {
            console.log("Resetting...");
            await fetch('/reset', { method: 'POST' });
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(updateFrame, 50); // Updates every 50ms
        }

        async function updateFrame() {
            try {
                const response = await fetch('/step');
                const data = await response.json();
                
                if(data.error) return;

                // 1. Clear Screen
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 2. Draw Perimeter (where prey spawn)
                ctx.strokeStyle = "rgba(255,255,255,0.06)";
                ctx.lineWidth = 1;
                ctx.strokeRect(0.5, 0.5, W-1, H-1);

                // 3. Draw Base (Green at center)
                ctx.fillStyle = "rgba(0, 255, 0, 0.2)";
                ctx.strokeStyle = "rgba(0, 255, 0, 0.6)";
                bases.forEach(b => {
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, 6, 0, Math.PI*2);
                    ctx.fill();
                    ctx.strokeRect(b.x - 12, b.y - 12, 24, 24);
                });

                // 4. Draw Prey (states: free, detected, reached, caught)
                data.prey.forEach(p => {
                    if (p.caught) {
                        // Caught prey: dark X
                        ctx.strokeStyle = "#000000";
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(p.x-6, p.y-6); ctx.lineTo(p.x+6, p.y+6);
                        ctx.moveTo(p.x+6, p.y-6); ctx.lineTo(p.x-6, p.y+6);
                        ctx.stroke();
                        ctx.lineWidth = 1;
                        return;
                    }

                    if (p.reached) {
                        // Reached base: green square
                        ctx.fillStyle = "#00ff00";
                        ctx.fillRect(p.x - 5, p.y - 5, 10, 10);
                        return;
                    }

                    if (p.detected) {
                        // Detected but not yet caught/reached: orange circle
                        ctx.fillStyle = "#ff9900";
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
                        ctx.fill();
                    } else {
                        // Free prey: red
                        ctx.fillStyle = "#ff4444";
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
                        ctx.fill();
                    }

                    // Draw line to target base if running
                    if(p.running) {
                        ctx.strokeStyle = "rgba(255, 68, 68, 0.25)";
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        ctx.lineTo(p.target[0], p.target[1]);
                        ctx.stroke();
                    }
                });

                // 4. Draw Drones (Blue with direction indicator)
                ctx.fillStyle = "#00aaff";
                ctx.strokeStyle = "#00aaff";
                data.drones.forEach(d => {
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Direction line
                    ctx.beginPath();
                    ctx.moveTo(d.x, d.y);
                    ctx.lineTo(d.x + Math.cos(d.angle)*15, d.y + Math.sin(d.angle)*15);
                    ctx.stroke();
                    
                    // Optional: FOV arc (faint)
                    ctx.strokeStyle = "rgba(0, 170, 255, 0.1)";
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, 20, d.angle - 0.5, d.angle + 0.5);
                    ctx.stroke();
                });

            } catch (e) {
                console.error("Error fetching step:", e);
                clearInterval(gameInterval);
            }
        }
    </script>
</body>
</html>