<!DOCTYPE html>
<html>
<head>
    <title>HUNTED Simulation</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: #eee; text-align: center; }
        #canvas-container { margin: 20px auto; display: inline-block; border: 4px solid #444; }
        canvas { background: #1a1a1a; display: block; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .legend { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

    <h1>HUNTED Swarm Prototype</h1>
    <button onclick="resetGame()">Start / Reset Simulation</button>
    
    <div id="canvas-container">
        <canvas id="simCanvas" width="800" height="800"></canvas>
    </div>

    <div class="legend">
        <span style="color:#00aaff">● Drones</span> | 
        <span style="color:#ff4444">● Prey</span> | 
        <span style="color:#00ff00">■ Bases</span>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        let gameInterval = null;

        // Base coordinates (Hardcoded to match sim logic for visualization)
        const W = 800, H = 800;
        const bases = [
            {x: W/2 - 150, y: H/2 - 150},
            {x: W/2 + 150, y: H/2 - 150},
            {x: W/2 - 150, y: H/2 + 150},
            {x: W/2 + 150, y: H/2 + 150}
        ];

        async function resetGame() {
            console.log("Resetting...");
            await fetch('/reset', { method: 'POST' });
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(updateFrame, 50); // Updates every 50ms
        }

        async function updateFrame() {
            try {
                const response = await fetch('/step');
                const data = await response.json();
                
                if(data.error) return;

                // 1. Clear Screen
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 2. Draw Bases (Green Zones)
                ctx.fillStyle = "rgba(0, 255, 0, 0.1)";
                ctx.strokeStyle = "rgba(0, 255, 0, 0.5)";
                bases.forEach(b => {
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, 5, 0, Math.PI*2); // Center point
                    ctx.fill();
                    // Draw square area approximate
                    ctx.strokeRect(b.x - 20, b.y - 20, 40, 40);
                });

                // 3. Draw Prey (Red)
                data.prey.forEach(p => {
                    if (p.alive) {
                        ctx.fillStyle = "#ff4444";
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Draw line to target base if running
                        if(p.running) {
                            ctx.strokeStyle = "rgba(255, 68, 68, 0.3)";
                            ctx.beginPath();
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p.target[0], p.target[1]);
                            ctx.stroke();
                        }
                    } else {
                        // Dead prey (X mark)
                        ctx.strokeStyle = "#550000";
                        ctx.beginPath();
                        ctx.moveTo(p.x-4, p.y-4); ctx.lineTo(p.x+4, p.y+4);
                        ctx.moveTo(p.x+4, p.y-4); ctx.lineTo(p.x-4, p.y+4);
                        ctx.stroke();
                    }
                });

                // 4. Draw Drones (Blue with direction indicator)
                ctx.fillStyle = "#00aaff";
                ctx.strokeStyle = "#00aaff";
                data.drones.forEach(d => {
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Direction line
                    ctx.beginPath();
                    ctx.moveTo(d.x, d.y);
                    ctx.lineTo(d.x + Math.cos(d.angle)*15, d.y + Math.sin(d.angle)*15);
                    ctx.stroke();
                    
                    // Optional: FOV arc (faint)
                    ctx.strokeStyle = "rgba(0, 170, 255, 0.1)";
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, 20, d.angle - 0.5, d.angle + 0.5);
                    ctx.stroke();
                });

            } catch (e) {
                console.error("Error fetching step:", e);
                clearInterval(gameInterval);
            }
        }
    </script>
</body>
</html>